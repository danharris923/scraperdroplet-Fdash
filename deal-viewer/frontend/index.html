<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deals</title>
<style>
/* ── Reset & Base ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0f1117; --bg2: #1a1d27; --bg3: #242833; --bg4: #2e3240;
  --text: #e4e4e7; --text2: #a1a1aa; --text3: #71717a;
  --accent: #22d3ee; --green: #22c55e; --yellow: #eab308; --red: #ef4444;
  --blue: #3b82f6; --purple: #a855f7;
  --radius: 8px;
  --sidebar-w: 260px;
}
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
a { color: var(--accent); text-decoration: none; }

/* ── Layout: sidebar + main ── */
.layout { display: flex; min-height: 100vh; }

/* ── Sidebar ── */
.sidebar {
  width: var(--sidebar-w); min-width: var(--sidebar-w);
  background: var(--bg2); border-right: 1px solid var(--bg3);
  height: 100vh; position: sticky; top: 0;
  display: flex; flex-direction: column;
  transition: margin-left 0.25s ease, opacity 0.25s ease;
  overflow: hidden; z-index: 150;
}
.sidebar.collapsed { margin-left: calc(var(--sidebar-w) * -1); opacity: 0; pointer-events: none; }

/* Sidebar header */
.sidebar-header {
  padding: 16px; display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--bg3); flex-shrink: 0;
}
.sidebar-header h1 { font-size: 18px; font-weight: 700; color: var(--accent); }
.sidebar-toggle {
  width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--bg4);
  background: var(--bg3); color: var(--text2); font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all 0.15s;
}
.sidebar-toggle:hover { border-color: var(--accent); color: var(--text); }

/* Sidebar scroll area for filters */
.sidebar-filters {
  flex: 1; overflow-y: auto; padding: 12px 16px;
  scrollbar-width: thin; scrollbar-color: var(--bg4) transparent;
}
.sidebar-filters::-webkit-scrollbar { width: 5px; }
.sidebar-filters::-webkit-scrollbar-track { background: transparent; }
.sidebar-filters::-webkit-scrollbar-thumb { background: var(--bg4); border-radius: 3px; }

/* Filter sections */
.filter-group { margin-bottom: 20px; }
.filter-group-title {
  font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
  color: var(--text3); margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--bg3);
}

/* Search inside sidebar */
.sidebar-search {
  width: 100%; background: var(--bg3); border: 1px solid var(--bg4); border-radius: var(--radius);
  padding: 8px 10px; color: var(--text); font-size: 13px; outline: none; transition: border-color 0.15s;
}
.sidebar-search:focus { border-color: var(--accent); }

/* Store list (checkboxes) */
.store-list { display: flex; flex-direction: column; gap: 2px; }
.store-item {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 8px; border-radius: 6px; cursor: pointer; transition: background 0.12s;
  font-size: 13px; color: var(--text2); user-select: none;
}
.store-item:hover { background: var(--bg3); }
.store-item.active { background: var(--bg3); color: var(--text); }
.store-item input[type="checkbox"] { display: none; }
/* Custom checkbox */
.store-check {
  width: 16px; height: 16px; border-radius: 4px; border: 1.5px solid var(--bg4);
  background: var(--bg); flex-shrink: 0; position: relative; transition: all 0.15s;
}
.store-item.active .store-check {
  background: var(--accent); border-color: var(--accent);
}
.store-item.active .store-check::after {
  content: ''; position: absolute; top: 2px; left: 5px;
  width: 4px; height: 8px; border: solid var(--bg); border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}
.store-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.store-count {
  font-size: 11px; color: var(--text3); background: var(--bg4); padding: 1px 6px;
  border-radius: 8px; flex-shrink: 0;
}

/* Dropdown selects in sidebar */
.sidebar-select {
  width: 100%; background: var(--bg3); border: 1px solid var(--bg4); border-radius: var(--radius);
  padding: 8px 10px; color: var(--text); font-size: 13px; cursor: pointer; outline: none;
  transition: border-color 0.15s; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2371717a' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
}
.sidebar-select:focus { border-color: var(--accent); }

/* Price range inputs */
.price-range-row { display: flex; gap: 8px; align-items: center; }
.price-input {
  flex: 1; background: var(--bg3); border: 1px solid var(--bg4); border-radius: var(--radius);
  padding: 8px 10px; color: var(--text); font-size: 13px; outline: none; width: 0;
  transition: border-color 0.15s;
}
.price-input:focus { border-color: var(--accent); }
.price-range-row .sep { color: var(--text3); font-size: 12px; }

/* Sort option in sidebar */
.sidebar-sort { margin-bottom: 20px; }

/* Clear all button */
.clear-filters {
  width: 100%; padding: 8px; background: transparent; border: 1px solid var(--bg4);
  border-radius: var(--radius); color: var(--text3); font-size: 12px; cursor: pointer;
  transition: all 0.15s; margin-top: 4px;
}
.clear-filters:hover { border-color: var(--red); color: var(--red); }
.clear-filters.has-filters { border-color: var(--accent); color: var(--accent); }

/* Active filter count badge on sidebar header */
.filter-count-badge {
  font-size: 11px; background: var(--accent); color: var(--bg); padding: 1px 7px;
  border-radius: 10px; font-weight: 700; display: none;
}
.filter-count-badge.visible { display: inline-block; }

/* ── Main Content ── */
.main { flex: 1; min-width: 0; display: flex; flex-direction: column; }

/* Top bar (minimal: just toggle + status) */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: var(--bg2); border-bottom: 1px solid var(--bg3);
  padding: 10px 20px; display: flex; align-items: center; gap: 12px;
}
.topbar-toggle {
  width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--bg4);
  background: var(--bg3); color: var(--text2); font-size: 18px; cursor: pointer;
  display: none; align-items: center; justify-content: center; transition: all 0.15s;
}
.topbar-toggle:hover { border-color: var(--accent); color: var(--text); }
/* Show topbar toggle only when sidebar is collapsed */
.sidebar.collapsed ~ .main .topbar-toggle { display: flex; }
.topbar-title {
  font-size: 16px; font-weight: 700; color: var(--accent); display: none;
}
.sidebar.collapsed ~ .main .topbar-title { display: block; }

/* Status info in topbar */
.status-info { font-size: 13px; color: var(--text2); flex: 1; }
.status-info .count { color: var(--text); font-weight: 600; }
.status-info .time { color: var(--text3); }

/* ── Product Grid ── */
.grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px; padding: 20px; flex: 1;
}

/* ── Product Card ── */
.card {
  background: var(--bg2); border: 1px solid var(--bg3); border-radius: var(--radius);
  overflow: hidden; cursor: pointer; transition: border-color 0.15s, transform 0.15s;
}
.card:hover { border-color: var(--accent); transform: translateY(-2px); }
.card-img {
  width: 100%; height: 180px; object-fit: contain; background: #fff; padding: 8px;
}
.card-img-placeholder {
  width: 100%; height: 180px; background: var(--bg3);
  display: flex; align-items: center; justify-content: center;
  font-size: 48px; color: var(--text3);
}
.card-body { padding: 12px; }
.card-title {
  font-size: 13px; font-weight: 500; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  min-height: 36px; color: var(--text);
}
.card-meta { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
.card-store {
  font-size: 11px; background: var(--bg4); padding: 2px 8px; border-radius: 10px; color: var(--text2);
}
.card-time { font-size: 11px; color: var(--text3); }
.card-price { display: flex; align-items: baseline; gap: 6px; margin-top: 8px; }
.card-price .current { font-size: 16px; font-weight: 700; color: var(--text); }
.card-price .original { font-size: 12px; color: var(--text3); text-decoration: line-through; }
.card-discount {
  display: inline-block; font-size: 11px; font-weight: 700; padding: 2px 6px;
  border-radius: 4px; margin-top: 6px;
}
.discount-ok     { background: rgba(34,197,94,0.15); color: var(--green); }
.discount-good   { background: rgba(59,130,246,0.15); color: var(--blue); }
.discount-epic   { background: rgba(168,85,247,0.15); color: var(--purple); }
.discount-legend { background: rgba(234,179,8,0.15); color: var(--yellow); }

/* ── Load More Sentinel ── */
#load-more { text-align: center; padding: 30px 20px; }

/* ── Loading & Empty ── */
.loading, .empty-state {
  text-align: center; padding: 80px 20px; color: var(--text3);
}
.loading::after {
  content: ''; display: block; width: 32px; height: 32px; margin: 16px auto;
  border: 3px solid var(--bg4); border-top-color: var(--accent); border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { font-size: 15px; }

/* ── Modal Overlay ── */
.modal-overlay {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
  overflow-y: auto; padding: 40px 20px;
}
.modal-overlay.open { display: flex; justify-content: center; align-items: flex-start; }
.modal {
  background: var(--bg2); border: 1px solid var(--bg3); border-radius: 12px;
  max-width: 700px; width: 100%; position: relative; animation: modalIn 0.2s ease-out;
}
@keyframes modalIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: none; } }
.modal-close {
  position: absolute; top: 12px; right: 12px; width: 32px; height: 32px;
  border-radius: 50%; border: none; background: var(--bg4); color: var(--text2);
  font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  z-index: 1;
}
.modal-close:hover { background: var(--red); color: #fff; }
.modal-img {
  width: 100%; max-height: 300px; object-fit: contain; background: #fff; padding: 16px;
  border-radius: 12px 12px 0 0;
}
.modal-body { padding: 20px; }
.modal-title { font-size: 18px; font-weight: 600; line-height: 1.4; margin-bottom: 12px; }
.modal-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.modal-badge {
  font-size: 12px; background: var(--bg4); padding: 3px 10px; border-radius: 12px; color: var(--text2);
}
.modal-price-row { display: flex; align-items: baseline; gap: 10px; margin-bottom: 4px; }
.modal-price-row .current { font-size: 28px; font-weight: 700; }
.modal-price-row .original { font-size: 16px; color: var(--text3); text-decoration: line-through; }
.modal-discount {
  font-size: 14px; font-weight: 700; padding: 3px 10px; border-radius: 6px; margin-bottom: 16px;
  display: inline-block;
}
.modal-dates { font-size: 13px; color: var(--text3); margin-bottom: 20px; }
.modal-dates span { color: var(--text2); }

/* Price chart */
.chart-section { margin-top: 16px; }
.chart-header { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: var(--text2); }
.chart-container { background: var(--bg); border-radius: var(--radius); padding: 16px; }
.chart-container svg { width: 100%; height: auto; }

/* View deal button */
.view-deal {
  display: inline-block; margin-top: 16px; padding: 10px 24px;
  background: var(--accent); color: var(--bg); font-weight: 600; font-size: 14px;
  border-radius: var(--radius); border: none; cursor: pointer; text-decoration: none;
}
.view-deal:hover { opacity: 0.9; }
.modal-url-row { display: flex; align-items: center; gap: 10px; margin-top: 16px; }
.copy-btn {
  padding: 10px 18px; background: var(--bg4); color: var(--text); font-size: 13px;
  border: 1px solid var(--bg4); border-radius: var(--radius); cursor: pointer; font-weight: 600;
  transition: all 0.15s;
}
.copy-btn:hover { border-color: var(--accent); }
.modal-url-display {
  margin-top: 8px; padding: 8px 12px; background: var(--bg); border-radius: var(--radius);
  font-size: 11px; color: var(--text3); font-family: monospace; word-break: break-all;
  border: 1px solid var(--bg3);
}

/* ── Responsive ── */
@media (max-width: 900px) {
  /* Sidebar becomes overlay on mobile */
  .sidebar {
    position: fixed; left: 0; top: 0; z-index: 200;
    box-shadow: 4px 0 24px rgba(0,0,0,0.5);
  }
  .sidebar.collapsed { margin-left: calc(var(--sidebar-w) * -1); }
  /* Always show topbar toggle on mobile */
  .topbar-toggle { display: flex !important; }
  .topbar-title { display: block !important; }
  .grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; padding: 12px; }
  .card-img, .card-img-placeholder { height: 140px; }
  .modal { margin: 0 8px; }
}
/* Mobile overlay backdrop */
.sidebar-backdrop {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 199;
}
.sidebar-backdrop.visible { display: block; }
</style>
</head>
<body>

<!-- Sidebar backdrop (mobile overlay) -->
<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<div class="layout">

  <!-- ── Left Sidebar: filters ── -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>Deals</h1>
      <span class="filter-count-badge" id="filter-badge">0</span>
      <button class="sidebar-toggle" id="sidebar-close" title="Collapse sidebar">&lsaquo;</button>
    </div>

    <div class="sidebar-filters">
      <!-- Search -->
      <div class="filter-group">
        <div class="filter-group-title">Search</div>
        <input type="text" class="sidebar-search" id="search-input" placeholder="Search deals...">
      </div>

      <!-- Stores (checkboxes) -->
      <div class="filter-group">
        <div class="filter-group-title">Stores</div>
        <div class="store-list" id="store-list"></div>
      </div>

      <!-- Discount -->
      <div class="filter-group">
        <div class="filter-group-title">Minimum Discount</div>
        <select class="sidebar-select" id="discount-filter">
          <option value="0">Any discount</option>
          <option value="10">10%+ off</option>
          <option value="25">25%+ off</option>
          <option value="50">50%+ off</option>
          <option value="75">75%+ off</option>
        </select>
      </div>

      <!-- Date range -->
      <div class="filter-group">
        <div class="filter-group-title">Date Range</div>
        <select class="sidebar-select" id="date-filter">
          <option value="">All time</option>
          <option value="1">Today</option>
          <option value="7">Last 7 days</option>
          <option value="30">Last 30 days</option>
        </select>
      </div>

      <!-- Price range -->
      <div class="filter-group">
        <div class="filter-group-title">Price Range</div>
        <div class="price-range-row">
          <input type="number" class="price-input" id="price-min" placeholder="Min $" min="0" step="1">
          <span class="sep">to</span>
          <input type="number" class="price-input" id="price-max" placeholder="Max $" min="0" step="1">
        </div>
      </div>

      <!-- Sort -->
      <div class="filter-group">
        <div class="filter-group-title">Sort By</div>
        <select class="sidebar-select" id="sort-filter">
          <option value="last_seen_at:desc">Recently seen</option>
          <option value="first_seen_at:desc">Newest first</option>
          <option value="discount_percent:desc">Biggest discount</option>
          <option value="current_price:asc">Price: low to high</option>
          <option value="current_price:desc">Price: high to low</option>
        </select>
      </div>

      <!-- Clear all -->
      <button class="clear-filters" id="clear-filters">Clear all filters</button>
    </div>
  </aside>

  <!-- ── Main content ── -->
  <div class="main">
    <!-- Top bar: sidebar toggle + status -->
    <div class="topbar" id="topbar">
      <button class="topbar-toggle" id="sidebar-open" title="Open filters">&rsaquo;</button>
      <span class="topbar-title">Deals</span>
      <div class="status-info" id="status-bar">Loading...</div>
    </div>

    <!-- Product grid -->
    <div class="grid" id="product-grid"></div>

    <!-- Lazy load sentinel -->
    <div id="load-more" class="loading" style="display:none">Loading more...</div>
  </div>

</div>

<!-- Detail modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal"></div>
</div>

<script>
// ══════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════
const state = {
  stores: [],           // available stores from /api/filters
  selectedSources: [],  // active source filter values
  search: '',
  minDiscount: 0,
  days: null,           // null = all time
  priceMin: null,
  priceMax: null,
  sortBy: 'last_seen_at',
  sortOrder: 'desc',
  page: 1,
  perPage: 99,
  totalProducts: 0,
  totalPages: 1,
  loading: false,
  allLoaded: false,     // true when no more pages to fetch
};

// Debounce helper
function debounce(fn, ms) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}

// ══════════════════════════════════════════════
// SIDEBAR TOGGLE
// ══════════════════════════════════════════════
const sidebar = document.getElementById('sidebar');
const backdrop = document.getElementById('sidebar-backdrop');

document.getElementById('sidebar-close').addEventListener('click', () => toggleSidebar(false));
document.getElementById('sidebar-open').addEventListener('click', () => toggleSidebar(true));
backdrop.addEventListener('click', () => toggleSidebar(false));

function toggleSidebar(show) {
  sidebar.classList.toggle('collapsed', !show);
  backdrop.classList.toggle('visible', show && window.innerWidth <= 900);
}

// ══════════════════════════════════════════════
// API
// ══════════════════════════════════════════════
const API_BASE = '/api';

async function apiFetch(path, params = {}) {
  const clean = {};
  for (const [k, v] of Object.entries(params)) {
    if (v !== null && v !== undefined && v !== '' && v !== 0) clean[k] = v;
  }
  const qs = new URLSearchParams(clean).toString();
  const url = `${API_BASE}${path}${qs ? '?' + qs : ''}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`API ${resp.status}: ${resp.statusText}`);
  return resp.json();
}

// ══════════════════════════════════════════════
// FORMATTING HELPERS
// ══════════════════════════════════════════════
function formatPrice(p) {
  if (p == null) return '';
  return '$' + Number(p).toFixed(2);
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const diff = Date.now() - new Date(dateStr).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  if (days < 30) return days + 'd ago';
  return Math.floor(days / 30) + 'mo ago';
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  return new Date(dateStr).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
}

function discountClass(pct) {
  if (pct >= 75) return 'discount-legend';
  if (pct >= 50) return 'discount-epic';
  if (pct >= 25) return 'discount-good';
  return 'discount-ok';
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ══════════════════════════════════════════════
// INIT: Load filters, then products
// ══════════════════════════════════════════════
async function init() {
  try {
    const data = await apiFetch('/filters');
    state.stores = data.stores || [];
    renderStoreList();
    await loadProducts();
  } catch (e) {
    document.getElementById('status-bar').textContent = 'Failed to connect to API: ' + e.message;
    document.getElementById('product-grid').innerHTML = '<div class="empty-state">Could not load data. Is the API server running?</div>';
  }
}

// ══════════════════════════════════════════════
// STORE LIST (checkbox style)
// ══════════════════════════════════════════════
function renderStoreList() {
  const container = document.getElementById('store-list');
  container.innerHTML = '';
  const frag = document.createDocumentFragment();
  for (const s of state.stores) {
    const item = document.createElement('label');
    item.className = 'store-item';
    item.dataset.source = s.value;
    item.innerHTML = `
      <input type="checkbox" value="${escapeHtml(s.value)}">
      <span class="store-check"></span>
      <span class="store-name">${escapeHtml(s.label)}</span>
      <span class="store-count">${s.count.toLocaleString()}</span>`;
    item.addEventListener('click', (e) => {
      e.preventDefault();
      toggleSource(s.value);
    });
    frag.appendChild(item);
  }
  container.appendChild(frag);
  updateStoreListStates();
}

function toggleSource(value) {
  const idx = state.selectedSources.indexOf(value);
  if (idx >= 0) {
    state.selectedSources.splice(idx, 1);
  } else {
    state.selectedSources.push(value);
  }
  updateStoreListStates();
  updateFilterBadge();
  resetAndLoad();
}

function updateStoreListStates() {
  document.querySelectorAll('.store-item').forEach(item => {
    const isActive = state.selectedSources.includes(item.dataset.source);
    item.classList.toggle('active', isActive);
    item.querySelector('input').checked = isActive;
  });
}

// ══════════════════════════════════════════════
// FILTER EVENT HANDLERS
// ══════════════════════════════════════════════
document.getElementById('search-input').addEventListener('input', debounce(e => {
  state.search = e.target.value.trim();
  updateFilterBadge();
  resetAndLoad();
}, 350));

document.getElementById('discount-filter').addEventListener('change', e => {
  state.minDiscount = parseInt(e.target.value) || 0;
  updateFilterBadge();
  resetAndLoad();
});

document.getElementById('date-filter').addEventListener('change', e => {
  state.days = e.target.value ? parseInt(e.target.value) : null;
  updateFilterBadge();
  resetAndLoad();
});

// Price range inputs (debounced)
const priceMinInput = document.getElementById('price-min');
const priceMaxInput = document.getElementById('price-max');
priceMinInput.addEventListener('input', debounce(() => {
  state.priceMin = priceMinInput.value ? parseFloat(priceMinInput.value) : null;
  updateFilterBadge();
  resetAndLoad();
}, 500));
priceMaxInput.addEventListener('input', debounce(() => {
  state.priceMax = priceMaxInput.value ? parseFloat(priceMaxInput.value) : null;
  updateFilterBadge();
  resetAndLoad();
}, 500));

// Sort
document.getElementById('sort-filter').addEventListener('change', e => {
  const [col, order] = e.target.value.split(':');
  state.sortBy = col;
  state.sortOrder = order;
  resetAndLoad();
});

// Clear all filters
document.getElementById('clear-filters').addEventListener('click', () => {
  state.selectedSources = [];
  state.search = '';
  state.minDiscount = 0;
  state.days = null;
  state.priceMin = null;
  state.priceMax = null;
  state.sortBy = 'last_seen_at';
  state.sortOrder = 'desc';

  // Reset inputs
  document.getElementById('search-input').value = '';
  document.getElementById('discount-filter').value = '0';
  document.getElementById('date-filter').value = '';
  document.getElementById('price-min').value = '';
  document.getElementById('price-max').value = '';
  document.getElementById('sort-filter').value = 'last_seen_at:desc';

  updateStoreListStates();
  updateFilterBadge();
  resetAndLoad();
});

// ══════════════════════════════════════════════
// FILTER BADGE (shows count of active filters)
// ══════════════════════════════════════════════
function updateFilterBadge() {
  let count = 0;
  if (state.selectedSources.length > 0) count++;
  if (state.search) count++;
  if (state.minDiscount > 0) count++;
  if (state.days) count++;
  if (state.priceMin != null) count++;
  if (state.priceMax != null) count++;

  const badge = document.getElementById('filter-badge');
  badge.textContent = count;
  badge.classList.toggle('visible', count > 0);

  const clearBtn = document.getElementById('clear-filters');
  clearBtn.classList.toggle('has-filters', count > 0);
  clearBtn.textContent = count > 0 ? `Clear all filters (${count})` : 'Clear all filters';
}

// Reset state and reload from page 1
function resetAndLoad() {
  state.page = 1;
  state.allLoaded = false;
  loadProducts(true);
}

// ══════════════════════════════════════════════
// LOAD PRODUCTS (with infinite scroll append)
// ══════════════════════════════════════════════
async function loadProducts(reset = false) {
  if (state.loading || (!reset && state.allLoaded)) return;
  state.loading = true;

  const grid = document.getElementById('product-grid');
  const loader = document.getElementById('load-more');

  if (reset) {
    grid.innerHTML = '<div class="loading">Loading deals...</div>';
  } else {
    loader.style.display = 'block';
  }

  try {
    const params = {
      page: state.page,
      per_page: state.perPage,
      sort_by: state.sortBy,
      sort_order: state.sortOrder,
    };
    if (state.selectedSources.length > 0) params.sources = state.selectedSources.join(',');
    if (state.search) params.search = state.search;
    if (state.minDiscount > 0) params.min_discount = state.minDiscount;
    if (state.days) params.days = state.days;
    if (state.priceMin != null) params.min_price = state.priceMin;
    if (state.priceMax != null) params.max_price = state.priceMax;

    const data = await apiFetch('/products', params);

    state.totalProducts = data.total;
    state.totalPages = data.total_pages;
    state.page = data.page;

    if (data.page >= data.total_pages || data.products.length === 0) {
      state.allLoaded = true;
    }

    renderStatusBar(data);

    if (reset) {
      grid.innerHTML = '';
    }
    appendCards(data.products);
  } catch (e) {
    if (reset) {
      grid.innerHTML = '<div class="empty-state">Error loading products: ' + escapeHtml(e.message) + '</div>';
    }
  } finally {
    state.loading = false;
    loader.style.display = 'none';
  }
}

// Load next page (called by IntersectionObserver)
function loadMore() {
  if (state.loading || state.allLoaded) return;
  state.page++;
  loadProducts(false);
}

// ══════════════════════════════════════════════
// STATUS BAR
// ══════════════════════════════════════════════
function renderStatusBar(data) {
  const bar = document.getElementById('status-bar');
  const sourceLabel = state.selectedSources.length > 0
    ? state.selectedSources.map(s => {
        const store = state.stores.find(st => st.value === s);
        return store ? store.label : s;
      }).join(', ')
    : 'all stores';
  const loaded = Math.min(data.page * data.per_page, data.total);
  bar.innerHTML = `Showing <span class="count">${loaded.toLocaleString()}</span> of <span class="count">${data.total.toLocaleString()}</span> deals from ${escapeHtml(sourceLabel)} <span class="time">(${data.query_time_ms}ms)</span>`;
}

// ══════════════════════════════════════════════
// PRODUCT GRID (append mode for infinite scroll)
// ══════════════════════════════════════════════
function appendCards(products) {
  const grid = document.getElementById('product-grid');
  if (!products.length && state.page === 1) {
    grid.innerHTML = '<div class="empty-state">No deals found matching your filters.</div>';
    return;
  }

  const frag = document.createDocumentFragment();
  for (const p of products) {
    const card = document.createElement('div');
    card.className = 'card';
    card.addEventListener('click', () => showDetail(p.id));

    const discount = p.discount_percent || 0;
    let discountHtml = '';
    if (discount > 0) {
      discountHtml = `<div class="card-discount ${discountClass(discount)}">-${Math.round(discount)}%</div>`;
    }

    let imgHtml;
    if (p.image_url) {
      imgHtml = `<img class="card-img" src="${escapeHtml(p.image_url)}" alt="" loading="lazy" onerror="this.outerHTML='<div class=card-img-placeholder>&#128722;</div>'">`;
    } else {
      imgHtml = '<div class="card-img-placeholder">&#128722;</div>';
    }

    const priceHtml = p.current_price
      ? `<span class="current">${formatPrice(p.current_price)}</span>${p.original_price && p.original_price > p.current_price ? `<span class="original">${formatPrice(p.original_price)}</span>` : ''}`
      : '<span class="current" style="color:var(--text3)">No price</span>';

    card.innerHTML = `
      ${imgHtml}
      <div class="card-body">
        <div class="card-title">${escapeHtml(p.title || 'Untitled')}</div>
        <div class="card-meta">
          <span class="card-store">${escapeHtml(p.store || '')}</span>
          <span class="card-time">${timeAgo(p.last_seen_at)}</span>
        </div>
        <div class="card-price">${priceHtml}</div>
        ${discountHtml}
      </div>`;
    frag.appendChild(card);
  }
  grid.appendChild(frag);
}

// ══════════════════════════════════════════════
// INFINITE SCROLL (IntersectionObserver)
// ══════════════════════════════════════════════
const scrollObserver = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting) loadMore();
}, { rootMargin: '400px' });
scrollObserver.observe(document.getElementById('load-more'));

// ══════════════════════════════════════════════
// DETAIL MODAL
// ══════════════════════════════════════════════
const overlay = document.getElementById('modal-overlay');
const modalEl = document.getElementById('modal');

overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function closeModal() {
  overlay.classList.remove('open');
  modalEl.innerHTML = '';
}

async function showDetail(productId) {
  overlay.classList.add('open');
  modalEl.innerHTML = '<div class="loading" style="padding:60px">Loading...</div>';

  try {
    const product = await apiFetch(`/product/${productId}`);
    renderModal(product);
  } catch (e) {
    modalEl.innerHTML = `<div class="empty-state" style="padding:40px">Failed to load product details.<br><small>${escapeHtml(e.message)}</small></div>`;
  }
}

function renderModal(p) {
  const discount = p.discount_percent || 0;
  let discountBadge = '';
  if (discount > 0) {
    discountBadge = `<div class="modal-discount ${discountClass(discount)}">-${Math.round(discount)}% off</div>`;
  }

  let imgHtml = '';
  if (p.image_url) {
    imgHtml = `<img class="modal-img" src="${escapeHtml(p.image_url)}" alt="" onerror="this.style.display='none'">`;
  }

  const priceHtml = p.current_price
    ? `<span class="current">${formatPrice(p.current_price)}</span>${p.original_price && p.original_price > p.current_price ? `<span class="original">${formatPrice(p.original_price)}</span>` : ''}`
    : '';

  let savingsHtml = '';
  if (p.current_price && p.original_price && p.original_price > p.current_price) {
    const saved = (p.original_price - p.current_price).toFixed(2);
    savingsHtml = `<div style="font-size:13px;color:var(--green);margin-bottom:12px;">You save $${saved}</div>`;
  }

  const history = p.price_history || [];
  const chartHtml = history.length > 0 ? renderPriceChart(history) : '';

  const descHtml = p.description ? `<div style="font-size:13px;color:var(--text2);margin-bottom:16px;line-height:1.5;">${escapeHtml(p.description)}</div>` : '';

  const urlStr = p.affiliate_url || '#';
  const urlDisplay = urlStr.length > 70 ? urlStr.substring(0, 70) + '...' : urlStr;

  modalEl.innerHTML = `
    <button class="modal-close" onclick="closeModal()">&times;</button>
    ${imgHtml}
    <div class="modal-body">
      <div class="modal-title">${escapeHtml(p.title || 'Untitled')}</div>
      <div class="modal-meta">
        <span class="modal-badge">${escapeHtml(p.store || '')}</span>
        ${p.source ? `<span class="modal-badge">${escapeHtml(p.source)}</span>` : ''}
        ${p.category ? `<span class="modal-badge">${escapeHtml(p.category)}</span>` : ''}
        ${p.brand ? `<span class="modal-badge">${escapeHtml(p.brand)}</span>` : ''}
      </div>
      <div class="modal-price-row">${priceHtml}</div>
      ${discountBadge}
      ${savingsHtml}
      <div class="modal-dates">
        First seen: <span>${formatDate(p.first_seen_at)}</span> &nbsp; Last seen: <span>${formatDate(p.last_seen_at)}</span>
        &nbsp; ID: <span style="color:var(--text3)">${escapeHtml(p.id || '')}</span>
      </div>
      ${descHtml}
      ${chartHtml}
      <div class="modal-url-row">
        <a class="view-deal" href="${escapeHtml(urlStr)}" target="_blank" rel="noopener">View Deal &rarr;</a>
        <button class="copy-btn" onclick="copyUrl(this, '${escapeHtml(urlStr.replace(/'/g, "\\'"))}')">Copy Link</button>
      </div>
      <div class="modal-url-display" title="${escapeHtml(urlStr)}">${escapeHtml(urlDisplay)}</div>
    </div>`;
}

function copyUrl(btn, url) {
  navigator.clipboard.writeText(url).then(() => {
    btn.textContent = 'Copied!';
    btn.style.background = 'var(--green)';
    setTimeout(() => { btn.textContent = 'Copy Link'; btn.style.background = ''; }, 1500);
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = url; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.textContent = 'Copy Link'; }, 1500);
  });
}

// ══════════════════════════════════════════════
// SVG PRICE HISTORY CHART
// ══════════════════════════════════════════════
function renderPriceChart(history) {
  if (!history.length) return '';

  const points = history.filter(h => h.price != null).map(h => ({
    price: Number(h.price),
    date: new Date(h.scraped_at),
    dateStr: h.scraped_at,
    onSale: h.is_on_sale,
  }));

  if (points.length === 0) return '';

  if (points.length === 1) {
    const pt = points[0];
    return `
      <div class="chart-section">
        <div class="chart-header">Price History (1 data point)</div>
        <div class="chart-container" style="text-align:center;padding:30px;">
          <div style="font-size:24px;font-weight:700;">${formatPrice(pt.price)}</div>
          <div style="font-size:13px;color:var(--text3);margin-top:4px;">${formatDate(pt.dateStr)}</div>
        </div>
      </div>`;
  }

  const W = 640, H = 220;
  const pad = { top: 20, right: 20, bottom: 40, left: 60 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  const prices = points.map(p => p.price);
  let minP = Math.min(...prices);
  let maxP = Math.max(...prices);
  const pRange = maxP - minP || 1;
  minP = Math.max(0, minP - pRange * 0.1);
  maxP = maxP + pRange * 0.1;

  const minT = points[0].date.getTime();
  const maxT = points[points.length - 1].date.getTime();
  const tRange = maxT - minT || 1;

  function x(date) { return pad.left + ((date.getTime() - minT) / tRange) * cw; }
  function y(price) { return pad.top + ch - ((price - minP) / (maxP - minP)) * ch; }

  const linePoints = points.map(p => `${x(p.date).toFixed(1)},${y(p.price).toFixed(1)}`).join(' ');
  const areaPoints = linePoints + ` ${x(points[points.length-1].date).toFixed(1)},${(pad.top + ch).toFixed(1)} ${x(points[0].date).toFixed(1)},${(pad.top + ch).toFixed(1)}`;

  let gridLines = '';
  const steps = 4;
  for (let i = 0; i <= steps; i++) {
    const pVal = minP + (maxP - minP) * (i / steps);
    const yPos = y(pVal);
    gridLines += `<line x1="${pad.left}" y1="${yPos.toFixed(1)}" x2="${W - pad.right}" y2="${yPos.toFixed(1)}" stroke="var(--bg3)" stroke-width="1"/>`;
    gridLines += `<text x="${pad.left - 8}" y="${(yPos + 4).toFixed(1)}" text-anchor="end" fill="var(--text3)" font-size="11">$${pVal.toFixed(0)}</text>`;
  }

  let dateLabels = '';
  const dateCount = Math.min(points.length, 5);
  const dateStep = Math.max(1, Math.floor(points.length / (dateCount - 1)));
  const shownDates = new Set();
  for (let i = 0; i < points.length; i += dateStep) {
    const p = points[i];
    const label = p.date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
    if (!shownDates.has(label)) {
      shownDates.add(label);
      dateLabels += `<text x="${x(p.date).toFixed(1)}" y="${H - 5}" text-anchor="middle" fill="var(--text3)" font-size="11">${label}</text>`;
    }
  }
  const lastP = points[points.length - 1];
  const lastLabel = lastP.date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
  if (!shownDates.has(lastLabel)) {
    dateLabels += `<text x="${x(lastP.date).toFixed(1)}" y="${H - 5}" text-anchor="middle" fill="var(--text3)" font-size="11">${lastLabel}</text>`;
  }

  let dots = '';
  for (let i = 0; i < points.length; i++) {
    const p = points[i];
    const cx = x(p.date).toFixed(1);
    const cy = y(p.price).toFixed(1);
    const color = p.onSale ? 'var(--green)' : 'var(--accent)';
    dots += `<circle cx="${cx}" cy="${cy}" r="4" fill="${color}" stroke="var(--bg2)" stroke-width="2"/>`;
    const tipDate = p.date.toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
    dots += `<circle cx="${cx}" cy="${cy}" r="12" fill="transparent" style="cursor:pointer"><title>${formatPrice(p.price)} - ${tipDate}${p.onSale ? ' (On Sale)' : ''}</title></circle>`;
  }

  return `
    <div class="chart-section">
      <div class="chart-header">Price History (${points.length} data points)</div>
      <div class="chart-container">
        <svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.3"/>
              <stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/>
            </linearGradient>
          </defs>
          ${gridLines}
          <polygon points="${areaPoints}" fill="url(#chartGrad)"/>
          <polyline points="${linePoints}" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linejoin="round"/>
          ${dateLabels}
          ${dots}
        </svg>
      </div>
    </div>`;
}

// ══════════════════════════════════════════════
// BOOT
// ══════════════════════════════════════════════
init();
</script>
</body>
</html>
